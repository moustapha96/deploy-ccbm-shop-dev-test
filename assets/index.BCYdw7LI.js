import{u as z,G as O,B as x,f as r,j as e,L as V,h as R,i as T,A as W,D as G,T as H,s as E,k as D}from"./index.CW09QBtC.js";import{m as J,b as i}from"./vendor.EKSpuOPe.js";import{f as K}from"./date-format.qL-o8H-f.js";import{P as k}from"./paimentService.BAH9_n5g.js";import{W as Q}from"./wave-orange-payment-service.SNFQge8E.js";function ne(){const{id:s}=J(),{user:m}=z(),[t,j]=i.useState(null),[q,v]=i.useState(!1),[P,f]=i.useState(!1),[c,_]=i.useState(null),[b,a]=i.useState(""),[C,g]=i.useState(0),[S,d]=i.useState(!0),M=i.useCallback(async()=>{try{const n=await O.getCommandeById(m.id,s);j(n);const u=await k.getPaymentDetailsByIdOrder(n.id);_(u)}catch(n){console.error("Erreur lors de la récupération des données de la commande",n),x.error("Erreur lors de la récupération des données de la commande")}},[m.id,s]);i.useEffect(()=>{M()},[M]),i.useEffect(()=>{const n=setTimeout(async()=>{t&&c&&c.payment_state==="completed"&&t.advance_payment_status==="not_paid"&&!c.token_status&&await F()},1e3);return()=>clearTimeout(n)},[c,t]);const h=i.useMemo(()=>String(t?.type_sale||"").toLowerCase()==="order",[t?.type_sale]),L=i.useMemo(()=>Array.isArray(t?.payment_lines)?t.payment_lines:null,[t]),w=i.useMemo(()=>L&&(L.find(n=>n.sequence===1)||L[0])||null,[L]),N=i.useMemo(()=>w?!w.state:!1,[w]),l=i.useMemo(()=>{const n=Number(t?.amount_residual||0);return h?n>0?50:0:t?.payment_mode==="echelonne"?N&&w?Math.max(0,Number(w.amount)||0):n<=0?0:Math.min(Math.max(1e3,0),n):1e3},[t?.amount_residual,t?.payment_mode,h,N,w]);i.useEffect(()=>{if(t){if(h){g(l),a("");return}t.payment_mode==="echelonne"?(g(l),a("")):t.payment_mode==="online"?(g(Number(t.amount_total||0)),a("")):(g(0),a(""))}},[t,l,h]);const F=async()=>{v(!0);try{await k.createCommandePaiment(t.id),window.location.reload(),x.success("Paiement de la commande validé avec succès")}catch(n){console.error("Erreur lors de la création du paiement :",n),x.error("Erreur lors de la création du paiement")}finally{v(!1)}},A=(n,u)=>{n.preventDefault();const y=Number(t?.amount_residual||0),o=Number(u||0);if(h){if(y<=0){x.info("Aucun montant restant à payer.");return}if(o<=0){a("Le montant doit être > 0.");return}if(o>y){a("Le montant ne doit pas dépasser le montant restant à payer.");return}a(""),f(!0);return}if(t.payment_mode==="echelonne"){if(y<=0){x.info("Aucun montant restant à payer.");return}if(N){if(o!==Number(l)){a(`Le montant doit être exactement l'acompte requis (${r(l)}).`);return}}else if(o<Number(l)){a(`Le montant doit être ≥ ${r(l)}.`);return}if(o>y){a("Le montant à payer ne doit pas dépasser le montant restant à payer");return}a(""),f(!0);return}if(t.payment_mode==="online"){if(o<1e3){a("Le montant minimum est de 1000 FCFA");return}if(o!==Number(t.amount_total||0)){a("Le montant à payer doit correspondre au total de la commande");return}a(""),f(!0);return}if(t.payment_mode==="domicile"){x.info("Le paiement se fera à domicile.");return}},$=async n=>{v(!1),x.success("Paiement validé avec succès")},B=()=>{c?.url_facture&&window.open(c.url_facture,"_blank","noopener,noreferrer")},I=async()=>{try{t?.advance_payment_status==="paid"&&c?.payment_state==="completed"?x.success("Commande déjà validée"):(await k.createCommandePaiment(t.id),x.success("Commande validée avec succès"))}catch(n){console.error("Erreur lors de la vérification du paiement :",n),x.error("Erreur lors de la vérification du paiement")}};return i.useEffect(()=>{if(!t)return;const n=Number(t?.amount_residual||0),u=Number(C||0);if(h){if(n<=0){d(!0);return}if(u<=0){a("Le montant doit être > 0."),d(!0);return}if(u>n){a("Le montant ne doit pas dépasser le montant restant à payer."),d(!0);return}a(""),d(!1);return}if(t.payment_mode==="echelonne"){if(n<=0){d(!0);return}if(N){const y=u===Number(l);d(!y),a(y?"":`Le montant doit être exactement l'acompte requis (${r(l)}).`);return}else{if(u<Number(l)){a(`Le montant doit être ≥ ${r(l)}.`),d(!0);return}if(u>n){a("Le montant à payer ne doit pas dépasser le montant restant à payer"),d(!0);return}a(""),d(!1);return}}if(t.payment_mode==="online"){u<1e3?(a("Le montant minimum est de 1000 FCFA"),d(!0)):u!==Number(t.amount_total||0)?(a("Le montant à payer doit correspondre au total de la commande"),d(!0)):(a(""),d(!1));return}d(!0)},[t,C,N,l,h]),t?e.jsxs(e.Fragment,{children:[e.jsx(R,{title:"CCBM Shop | Détails commande",description:"Consultez les détails de votre commande sur CCBM Shop, votre destination pour l'électroménager de qualité.",keywords:"détails commande, CCBM Shop, ccbme, suivi commande, paiement électroménager"}),e.jsx(T,{childrenClasses:" pt-0 pb-0",children:e.jsxs("div",{className:"checkout-page-wrapper w-full bg-white pb-[60px]",children:[e.jsx("div",{className:"w-full mb-5",children:e.jsx(W,{title:"Détails Commande",breadcrumb:[{name:"Accueil",path:"/"},{name:"Commandes",path:"/profile#order"},{name:"Détails Commande"}]})}),e.jsx("div",{className:"checkout-main-content w-full",children:e.jsxs("div",{className:"container-x mx-auto",children:[e.jsxs("div",{className:"w-full sm:mb-10 mb-5",children:[e.jsxs("div",{className:"sm:flex sm:space-x-[18px]",children:[e.jsx(p,{label:"N°Commande",value:t.name}),t.payment_mode==="domicile"&&e.jsx(p,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"A domicile":"Non Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":"text-green-500"}),t.payment_mode==="online"&&e.jsx(p,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"Non Payé":"Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":"text-green-500"}),t.payment_mode==="echelonne"&&e.jsx(p,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"Non Payé":t.advance_payment_status==="paid"?"Payé":"Partiellement Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":t.advance_payment_status==="paid"?"text-green-500":t.advance_payment_status==="partial"?"text-yellow-500":""}),e.jsx(p,{label:"Statut",value:t.state==="sale"?"Validée":t.state==="to_delivered"?"En cours de livraison":t.state==="delivered"?"Livrée":"Non validé",className:t.state==="sale"?"text-green-500":t.state==="to_delivered"?"text-yellow-500":t.state==="delivered"?"text-green-600":"text-gray-500"})]}),t.payment_mode==="echelonne"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"sm:flex sm:space-x-[18px] mt-5",children:[e.jsx(p,{label:"Montant Restant",value:`${r(t.amount_residual)}`}),e.jsx(p,{label:"Montant Total",value:["not_paid","paid"].includes(t.advance_payment_status)?e.jsx("span",{className:`text-${t.advance_payment_status==="not_paid"?"red":"green"}-500`,children:r(t.amount_total)}):e.jsxs(e.Fragment,{children:[" ",r(t.amount_total)]})}),e.jsx(p,{label:"Montant Avancé",value:r(t.amount_total-t.amount_residual)})]})}),e.jsxs("div",{className:"sm:flex sm:space-x-[18px] mt-5",children:[e.jsx(p,{label:"Mode de Paiement",value:t.payment_mode==="online"?"En ligne":t.payment_mode==="domicile"?"A domicile":"Echelonné"}),e.jsx(p,{label:"Date de livraison",value:K(t.commitment_date)})]})]}),c&&t.advance_payment_status==="paid"&&e.jsx(U,{paymentDetails:c,handleOpenInvoice:B,handleVerifeCommandePayment:I,commande:t}),e.jsx(X,{commande:t}),e.jsx(Y,{commande:t,montantAPayer:C,setMontantAPayer:n=>{const u=Number(t?.amount_residual||0),y=Number(n||0),o=Math.min(y,u);if(g(o),h){o<=0?a("Le montant doit être > 0."):a("");return}t.payment_mode==="echelonne"?N?o!==Number(l)?a(`Le montant doit être exactement l'acompte requis (${r(l)}).`):a(""):o<Number(l)?a(`Le montant doit être ≥ ${r(l)}.`):a(""):t.payment_mode==="online"&&(o<1e3?a("Le montant minimum est de 1000 FCFA"):o!==Number(t.amount_total||0)?a("Le montant à payer doit correspondre au total de la commande"):a(""))},errorMontantAPayer:b,stateButton:S,isLoading:q,validerPaiment:A,minAmountToPay:l,acompteDue:N,isTypeOrder:h}),P&&t&&e.jsx(Q,{handlePay:$,totalAmount:C,onClose:()=>f(!1),order:t,idOrder:t.id})]})})]})})]}):e.jsxs("div",{className:"flex justify-center items-center",children:[e.jsx(V,{className:"animate-spin mr-2"})," Chargement de la commande..."]})}const p=({label:s,value:m,className:t=""})=>e.jsx("div",{className:"sm:w-1/3 w-full mb-5 h-[70px]",children:e.jsx("div",{className:"w-full h-full bg-[#F6F6F6] text-qblack flex justify-center items-center",children:e.jsxs("span",{className:"text-[15px] font-medium",children:[s,"  : ",e.jsx("span",{className:t,children:m})]})})}),U=({paymentDetails:s,handleOpenInvoice:m,handleVerifeCommandePayment:t,commande:j})=>e.jsx("div",{className:"w-full lg:flex lg:space-x-[30px] mb-10",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif paiement"}),e.jsxs("div",{className:"w-full px-10 py-[30px] border border-[#EDEDED]",children:[e.jsx("div",{className:"sub-total mb-6",children:e.jsx("div",{className:"flex justify-between mb-5",children:e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Détail Payment"})})}),e.jsx("div",{className:"product-list w-full mb-[30px]",children:e.jsxs("ul",{className:"flex flex-col space-y-5",children:[e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Montant Payé"}),e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:r(s.amount)})]})}),e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Facture"}),e.jsx("button",{className:"text-[15px] text-qblack font-medium underline",onClick:m,children:"Ouvrir la facture"})]})}),j&&j.advance_payment_status==="not_paid"&&s.payment_state==="completed"&&e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Vérifier la commande"}),e.jsx("button",{className:"text-[15px] text-qblack font-medium underline",onClick:t,children:"Verifier"})]})})]})}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED]"})]})]})}),X=({commande:s})=>e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif de la commande"}),e.jsxs("div",{className:"w-full p-4 sm:p-6 border border-[#EDEDED] rounded-lg shadow-sm",children:[e.jsx("div",{className:"sub-total mb-6",children:e.jsxs("div",{className:"flex justify-between mb-5",children:[e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Produit"}),s.type_order==="commande"&&e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Total"})]})}),e.jsx("div",{className:"product-list w-full mb-[30px]",children:e.jsx("ul",{className:"flex flex-col space-y-5",children:s.order_lines.map((m,t)=>e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-[15px] text-qblack mb-2.5",children:[m.product_name,e.jsx("sup",{className:"text-[13px] text-qgray ml-2 mt-2",children:s.type_order==="commande"&&e.jsxs("span",{children:[" = ",m.product_uom_qty," x ",r(m.price_total)]})})]}),e.jsx("p",{className:"text-[13px] text-qgray",children:m.description})]}),e.jsx("div",{children:s.type_order==="commande"&&e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:r(m.price_total)})})]})},t))})}),e.jsx("div",{className:"mt-[30px]",children:e.jsxs("div",{className:"flex justify-between mb-5",children:[e.jsx("p",{className:"text-2xl font-medium text-qblack",children:"Total"}),e.jsx("p",{className:"text-2xl font-medium",children:["not_paid","paid"].includes(s.advance_payment_status)&&e.jsx("span",{className:`text-${s.advance_payment_status==="not_paid"?"red":"green"}-500`,children:r(s.amount_total)})})]})})]})]}),Y=({commande:s,montantAPayer:m,setMontantAPayer:t,errorMontantAPayer:j,stateButton:q,isLoading:v,validerPaiment:P,minAmountToPay:f,acompteDue:c,isTypeOrder:_})=>e.jsx("div",{className:"w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-8",children:s.advance_payment_status==="not_paid"||s.advance_payment_status==="partial"?e.jsxs(e.Fragment,{children:[s.payment_mode==="domicile"&&e.jsx("div",{className:"flex justify-center items-center mt-2",children:e.jsx("span",{className:"text-lg font-medium text-red-500 dark:text-white",children:"Le paiement se fera à domicile"})}),(s.payment_mode==="echelonne"||_)&&e.jsxs("div",{children:[e.jsxs("div",{className:"input-item mb-5",children:[e.jsx("div",{className:"mb-2 inline-block",children:e.jsx(G,{htmlFor:"montant",value:"Montant à payer"})}),e.jsx(H,{id:"montant",placeholder:_?"Montant libre (> 0)":c?`Acompte requis: ${r(f)}`:"Minimum 1000 F CFA",label:"Montant*",name:"montantAPayer",type:"number",value:m,onChange:b=>t(b.target.value),max:s.amount_residual,min:_?1:c?Number(f):0,required:!0,className:"invalid:border-red-500 invalid:text-red-600 focus:invalid:border-red-500 focus:invalid:ring-red-500"}),j&&e.jsx("p",{className:"text-yellow-500",children:j})]}),e.jsxs(E,{type:"submit",onClick:b=>P(b,m),className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",disabled:q,children:[v&&e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Passer à la caisse (",r(m),")"]}),e.jsx("p",{className:"mt-2 text-xs text-gray-500 text-center",children:_?e.jsxs(e.Fragment,{children:["Paiement libre : choisissez le montant que vous souhaitez (strictement > 0), jusqu’à ",e.jsx("strong",{children:r(s.amount_residual)})," restant."]}):c?e.jsxs(e.Fragment,{children:["Acompte requis : ",e.jsx("strong",{children:r(f)}),". Vous devrez solder l’acompte avant de pouvoir payer librement."]}):e.jsxs(e.Fragment,{children:["Paiement libre : choisissez le montant que vous souhaitez (minimum ",e.jsx("strong",{children:r(Math.max(1e3,Number(f)||0))}),"), jusqu’à ",e.jsx("strong",{children:r(s.amount_residual)})," restant."]})})]}),s.payment_mode==="online"&&!_&&e.jsxs(E,{type:"submit",onClick:b=>P(b,s.amount_total),className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",disabled:v,children:[v&&e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}),"Passer à la caisse (",r(s.amount_total),")"]})]}):e.jsx("div",{className:"w-full h-[50px] flex justify-center items-center",children:e.jsx("span",{className:"text-green-500",children:"Le paiement a été effectué avec succès"})})});export{ne as default};
