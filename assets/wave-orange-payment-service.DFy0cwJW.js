import{x as me,u as de,j as e,M as S,y as ue,f as C,s as b,k as V,K as L,B as d,z as pe,O as I}from"./index.GaW_aigY.js";import{b as l,u as xe}from"./vendor.EKSpuOPe.js";import{P as M}from"./paimentService.BASByJhl.js";const he="/assets/wave-image.DnO_I3CT.png",fe="/assets/om-image.CBEzpwAR.png",ge=["70","75","76","77","78"],N=u=>{if(!u)return"";let t=String(u).replace(/[^\d]+/g,"");return t.startsWith("00221")?t=t.slice(5):t.startsWith("221")?t=t.slice(3):t.startsWith("0")&&(t=t.slice(1)),t.length===9&&ge.includes(t.slice(0,2))?`221${t}`:(t.length===12&&t.startsWith("221"),t)},ye=u=>/^221(70|75|76|77|78)\d{7}$/.test(u),je=(u="REF")=>`${u}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,ve=(u,t,y,r,m)=>[u,t,y,r,m,Date.now()].filter(Boolean).join("-"),we=()=>typeof navigator<"u"&&/Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),Se=({handlePay:u,totalAmount:t,onClose:y,order:r,idOrder:m})=>{l.useEffect(()=>{localStorage.setItem("idOrderPayment",""),localStorage.setItem("montant",""),localStorage.setItem("tokenOrderPayment",""),localStorage.setItem("statusOrderPayment",""),localStorage.setItem("idDataPayment",""),localStorage.setItem("mm_transaction_id",""),localStorage.setItem("mm_method","")},[]);const P=xe(),{setUserPayment:q,setOrder:B}=l.useContext(me),{user:p,token:be}=de(),[j,v]=l.useState(!1),[Q,k]=l.useState(!0),[n,$]=l.useState(""),[g,A]=l.useState(""),[X,H]=l.useState(!1),[K,G]=l.useState(""),[J,Y]=l.useState(""),[R,z]=l.useState(!1),[D,Z]=l.useState(null),[E,ee]=l.useState(null),[F,te]=l.useState(null),x=l.useRef(null),h=l.useRef(null);l.useEffect(()=>{q?.(p),B?.(r)},[]),l.useEffect(()=>()=>{x.current&&clearInterval(x.current),h.current&&clearTimeout(h.current)},[]);const ae=s=>ye(N(s)),se=async s=>{if(s.preventDefault(),!n){d.error("Veuillez sélectionner une méthode de paiement",{position:"top-center",autoClose:3e3});return}if(!g){d.error("Veuillez entrer votre numéro de téléphone",{position:"top-center",autoClose:3e3});return}const i=N(g);if(!ae(i)){d.error("Numéro invalide. Utilisez 77/78/76/75/70 au format 221771234567",{position:"top-center",autoClose:4e3});return}v(!0);try{pe(m,t,(r?.order_lines||[]).map(o=>({name:o.product_name,price:o.price_unit,quantity:o.product_uom_qty})));const a=ve(p?.id,m,Math.ceil(t),r?.name,r?.type_sale),c=je(n==="wave"?"WAV":"OM");G(c);const oe=n==="wave"?`${window.location.origin}/wave-paiement?transaction=${encodeURIComponent(a)}`:`${window.location.origin}/om-paiement?transaction=${encodeURIComponent(a)}`,f=await I.initiatePayment(n,{transaction_id:a,order_id:m,partner_id:p?.id,phoneNumber:i,amount:Math.ceil(t),description:`${r?.name||"Commande"} - ${m}`,reference:c,success_url:oe}),ie={transaction_id:a,amount:Math.ceil(t),order_id:m,order_type:r?.type_sale,order_name:r?.name,partner_id:p?.id,payment_token:c,payment_state:"pending",payment_method:n,customer_phone:i,provider_status:f?.status||"pending"},U=await M.setPaymentDetails(ie);localStorage.setItem("idOrderPayment",String(m)),localStorage.setItem("montant",String(Math.ceil(t))),localStorage.setItem("tokenOrderPayment",c),localStorage.setItem("statusOrderPayment","pending"),localStorage.setItem("idDataPayment",U?.id?String(U.id):""),localStorage.setItem("mm_transaction_id",a),localStorage.setItem("mm_method",n),Y(a),H(!0);const W=we();if(n==="orange"){const o=f?.qr_code_base64,_=f?.deep_link_maxit||f?.deep_link||f?.short_link;if(W&&_)ee(_),window.location.href=_;else if(o){const ce=o.startsWith("data:image")?o:`data:image/png;base64,${o}`;Z(ce)}}if(n==="wave"){const o=f?.payment_url||f?.deep_link||f?.short_link;o&&(te(o),W?window.location.href=o:window.open(o,"_blank","noopener,noreferrer"))}d.success(`Demande envoyée via ${n==="wave"?"Wave":"Orange Money"}. Validez sur votre téléphone.`,{position:"top-center",autoClose:5e3}),ne(a,n)}catch(a){console.error(a),d.error(`Erreur lors du paiement: ${a?.message||"échec inconnu"}`,{position:"top-center",autoClose:5e3})}finally{v(!1)}},ne=(s,i)=>{x.current&&clearInterval(x.current),h.current&&clearTimeout(h.current),z(!0),x.current=setInterval(async()=>{try{const a=await I.verifyPayment(i,s),c=String(a?.status||a?.transaction?.status||"").toLowerCase();["completed","success","succeeded"].includes(c)?await T():["failed","canceled","cancelled","rejected","expired"].includes(c)&&await O(a?.reason||`Paiement ${c}`)}catch(a){console.warn("Polling error:",a?.message)}},4e3),h.current=setTimeout(()=>{w(),d.info("Toujours en attente de confirmation… Vous pouvez relancer la vérification.",{position:"top-center"})},12e4)},w=()=>{x.current&&clearInterval(x.current),h.current&&clearTimeout(h.current),x.current=null,h.current=null,z(!1)},T=async()=>{w();try{await M.updatePaymentDetails(localStorage.getItem("idDataPayment"),"completed","",p?.name,p?.email,N(g),"completed"),d.success("Paiement confirmé avec succès !",{position:"top-center",autoClose:3e3}),r?.type_sale==="preorder"?P(`/pre-commandes/${m}/détails`):r?.type_sale==="creditorder"?P(`/credit-commandes/${m}/détails`):P(`/commandes/${m}/détails`),k(!1)}catch(s){console.error(s),d.error("Paiement reçu mais échec de mise à jour locale.",{position:"top-center"})}},O=async s=>{w();try{await M.updatePaymentDetails(localStorage.getItem("idDataPayment"),"failed",s||"",p?.name,p?.email,N(g),"failed")}catch(i){console.error(i)}d.error(`Paiement échoué: ${s||"Refusé par l'opérateur"}`,{position:"top-center",autoClose:5e3})},re=async()=>{const s=J||localStorage.getItem("mm_transaction_id"),i=n||localStorage.getItem("mm_method");if(!(!s||!i)){v(!0);try{const a=await I.verifyPayment(i,s),c=String(a?.status||a?.transaction?.status||"").toLowerCase();["completed","success","succeeded"].includes(c)?await T():["failed","canceled","cancelled","rejected","expired"].includes(c)?await O(a?.reason||`Paiement ${c}`):d.warning("Toujours en attente de validation sur votre téléphone.",{position:"top-center",autoClose:4e3})}catch(a){d.error(`Erreur lors de la vérification: ${a?.message||"inconnue"}`,{position:"top-center",autoClose:5e3})}finally{v(!1)}}},le=()=>{w(),k(!1),y?.()};return e.jsxs(S,{size:"xl",className:"h-auto",show:Q,popup:!0,onClose:y,children:[e.jsx(S.Header,{}),e.jsx(S.Body,{children:e.jsx("div",{className:"fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]",children:e.jsxs("div",{className:"w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-300 pb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-gray-800 text-xl font-bold",children:["Paiement"," ",r?.type_sale==="order"?"Commande":r?.type_sale==="preorder"?"Pré-Commande":"Commande à crédit"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Résumé détaillé de votre commande."})]}),e.jsx("p",{children:e.jsx(ue,{onClick:le,className:"cursor-pointer hover:text-red-500 hover:scale-150 duration-300"})})]}),r&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-8",children:[e.jsx("table",{className:"w-full",children:e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom de la commande :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:r.name})]})})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom produit"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:"Prix total"})]})}),e.jsx("tbody",{children:(r.order_lines||[]).map((s,i)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"text-left text-gray-800 text-sm py-2",children:[s.product_name," (",s.product_uom_qty,")"]}),e.jsx("td",{className:"text-right text-gray-800 text-sm py-2 font-medium",children:C(s.price_total)})]},i))})]}),e.jsx("table",{className:"w-full",children:e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Total Commande (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:C(Math.ceil(r.amount_total))})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Montant à payer (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:C(Math.ceil(t))})]})]})}),X?e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-800 font-medium mb-2",children:"Paiement en attente"}),e.jsx("p",{className:"text-yellow-700 text-sm",children:"Vérifiez votre téléphone et confirmez le paiement."}),e.jsxs("p",{className:"text-yellow-700 text-sm mt-2",children:["Référence: ",e.jsx("span",{className:"font-medium",children:K})]})]}),n==="orange"&&e.jsxs(e.Fragment,{children:[D&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:D,alt:"QR Orange Money",className:"w-60 h-60 object-contain border rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Scannez ce QR dans l’app Orange Money pour finaliser."})]}),E&&e.jsxs(b,{onClick:()=>window.location.href=E,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-orange-600 hover:bg-orange-700 text-white",children:["Ouvrir Orange Money ",e.jsx(L,{className:"ml-2 inline h-4 w-4"})]})]}),n==="wave"&&F&&e.jsxs(b,{onClick:()=>window.location.href=F,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-blue-600 hover:bg-blue-700 text-white",children:["Ouvrir Wave ",e.jsx(L,{className:"ml-2 inline h-4 w-4"})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4",children:e.jsx(b,{onClick:re,disabled:j||R,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-green-600 hover:bg-green-700 text-white text-xl",children:j?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Vérification..."})]}):R?"Vérification automatique en cours…":"Vérifier le paiement"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 mb-4",children:[e.jsx("h4",{className:"text-gray-800 font-medium mb-3",children:"Choisissez votre méthode de paiement"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="wave"?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300"}`,onClick:()=>$("wave"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:he,width:100,alt:""})})}),e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="orange"?"border-orange-500 bg-orange-50":"border-gray-300 hover:border-orange-300"}`,onClick:()=>$("orange"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:fe,width:100,alt:""})})})]})]}),n&&e.jsxs("div",{className:"mt-4 mb-6",children:[e.jsxs("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:["Numéro ",n==="wave"?"Wave":"Orange Money"]}),e.jsx("input",{type:"tel",id:"phone",value:g,onChange:s=>A(s.target.value),placeholder:"77 123 45 67",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Utilisez un numéro sénégalais (ex: 221771234567). 77/78/76/75/70 acceptés."})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4 mt-8",children:e.jsx(b,{onClick:se,disabled:j||!n||!g,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",children:j?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Traitement en cours..."})]}):"Payer maintenant"})})]})]})})]})})})]})};export{Se as W};
